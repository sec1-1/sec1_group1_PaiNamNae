datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  PASSENGER
  DRIVER
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RouteStatus {
  AVAILABLE
  FULL
  COMPLETED
  CANCELLED
  IN_TRANSIT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
}

enum CancelReason {
  CHANGE_OF_PLAN
  FOUND_ALTERNATIVE
  DRIVER_DELAY
  PRICE_ISSUE
  WRONG_LOCATION
  DUPLICATE_OR_WRONG_DATE
  SAFETY_CONCERN
  WEATHER_OR_FORCE_MAJEURE
  COMMUNICATION_ISSUE
}

enum LicenseType {
  PRIVATE_CAR_TEMPORARY
  PRIVATE_CAR
  PUBLIC_CAR
  LIFETIME
}

enum NotificationType {
  SYSTEM
  VERIFICATION
  BOOKING
  ROUTE
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReportType {
  INAPPROPRIATE_BEHAVIOR
  NO_SHOW
  SCAM
  SAFETY_CONCERN
  OTHER
}

model User {
  id                      String    @id @default(cuid())
  strikeCount             Int       @default(0)
  username                String    @unique
  email                   String    @unique
  password                String
  firstName               String?
  lastName                String?
  gender                  String?
  phoneNumber             String?
  profilePicture          String?
  nationalIdNumber        String?   @unique
  nationalIdPhotoUrl      String?   @unique
  nationalIdExpiryDate    DateTime?
  selfiePhotoUrl          String?
  role                    Role      @default(PASSENGER)
  isVerified              Boolean   @default(false)
  isActive                Boolean   @default(true)
  otpCode                 String?
  lastLogin               DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  passengerSuspendedUntil DateTime?
  driverSuspendedUntil    DateTime?

  // relations
  driverVerification DriverVerification?
  vehicles           Vehicle[]
  notification       Notification[]
  createdRoutes      Route[]             @relation("DriverRoutes")
  bookings           Booking[]           @relation("PassengerBookings")

  // ⭐ FIX สำคัญ (Report relations)
  reportsMade     Report[] @relation("Reporter")
  reportsReceived Report[] @relation("ReportedUser")

  // ⭐ FIX สำคัญ (Blacklist relation)
  blacklistEntries Blacklist[]

  @@index([role])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdAt])
}

model DriverVerification {
  id                 String             @id @default(cuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseNumber      String             @unique
  firstNameOnLicense String
  lastNameOnLicense  String
  licenseIssueDate   DateTime
  licenseExpiryDate  DateTime
  licensePhotoUrl    String
  selfiePhotoUrl     String
  typeOnLicense      LicenseType
  status             VerificationStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([status])
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     NotificationType @default(SYSTEM)
  title    String
  body     String
  link     String?
  metadata Json?            @db.Json

  readAt          DateTime?
  createdAt       DateTime  @default(now())
  adminReviewedAt DateTime?

  @@index([userId, createdAt])
}

model Vehicle {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleModel String
  licensePlate String   @unique
  vehicleType  String
  color        String
  seatCapacity Int
  amenities    String[]
  photos       Json?    @db.Json
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  routes Route[]

  @@index([userId])
}

model Route {
  id             String      @id @default(cuid())
  driverId       String
  driver         User        @relation("DriverRoutes", fields: [driverId], references: [id], onDelete: Cascade)
  vehicleId      String
  vehicle        Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  startLocation  Json        @db.Json
  endLocation    Json        @db.Json
  departureTime  DateTime
  availableSeats Int
  pricePerSeat   Float
  conditions     String?
  status         RouteStatus @default(AVAILABLE)
  cancelledAt    DateTime?
  cancelledBy    String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  bookings Booking[]

  @@index([driverId])
}

model Booking {
  id              String        @id @default(cuid())
  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)
  passengerId     String
  passenger       User          @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)
  numberOfSeats   Int
  status          BookingStatus @default(PENDING)
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelReason    CancelReason?
  pickupLocation  Json          @db.Json
  dropoffLocation Json          @db.Json
  createdAt       DateTime      @default(now())

  // ⭐ FIX: opposite relation
  reports Report[]
}

model Report {
  id         String @id @default(cuid())
  reporterId String
  reporter   User   @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  reportedUserId String
  reportedUser   User   @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  penaltyApplied   Boolean @default(false)

  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  type        ReportType
  description String
  evidenceUrl String?

  status     ReportStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?

  createdAt DateTime @default(now())

  @@index([reportedUserId])
  @@index([status])
}

model Blacklist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason    String
  createdBy String
  createdAt DateTime @default(now())
}
